image: docker:stable

variables:
  LATEST_VER: $CI_REGISTRY_IMAGE:latest
  MAJOR_VER: $CI_REGISTRY_IMAGE:1.2.0

stages:
  - build

build:
  stage: build
  only:
  - master
  services:
   - name: $CI_REGISTRY/group/project/docker:19.03.1-dind
     alias: docker
  variables:
    # Specify to Docker where to create the certificates, Docker will
    # create them automatically on boot, and will create
    # `/certs/client` that will be shared between the service and
    # build container.
    DOCKER_TLS_CERTDIR: "/certs"
  script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  - docker build . -t $LATEST_VER
  - docker tag $LATEST_VER $MAJOR_VER
  - docker push $LATEST_VER && docker image rm $LATEST_VER
  - docker push $MAJOR_VER && docker image rm $MAJOR_VER